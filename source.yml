version: 2.1
description: An Orb that can be used to update and publish a Stoplight project.
commands:
  publish:
    parameters:
      organization:
        type: string
      project:
        type: string
      username:
        type: string
      api_token:
        type: string
      git_token:
        type: string
      source_dir:
        type: string
      domain:
        type: string
      version:
        type: string
        default: "1.0"
      git_name:
        type: string
        default: deployer
      git_email:
        type: string
        default: deployer@example.com
    steps:
      - checkout:
          path: source
      - run:
          name: Install jq
          command: sudo apt-get update && sudo apt-get install -y jq
      - run:
          name: Set up Git
          command: |
            git config --global user.name "<<parameters.git_name>>"
            git config --global user.email "<<parameters.git_email>>"
      - run:
          name: Clone Stoplight repo
          command: |
            export STOPLIGHT_REPO_URL=https://<<parameters.username>>:<<parameters.git_token>>@git.stoplight.io/<<parameters.organization>>/<<parameters.project>>.git
            export STOPLIGHT_REPO_BRANCH=version/<<parameters.version>>
            git clone $STOPLIGHT_REPO_URL stoplight
            cd stoplight
            git checkout $STOPLIGHT_REPO_BRANCH
      - run:
          name: Update Stoplight documentation
          working_directory: stoplight
          command: |
            find . -path ./.git -prune -o -exec rm -rf {} \; 2> /dev/null
            cp -r ../source/<<parameters.source_dir>>/* .
            git add .
            git diff-index --quiet HEAD || git commit -m "Update API docs with $CIRCLE_SHA1"
            git push origin $STOPLIGHT_REPO_BRANCH
      - run:
          name: Publish Stoplight documentation
          command: |
            mkdir -p /tmp/stoplight
            curl --request POST \
              --url "https://next-api.stoplight.io/docs.release?domain=<<parameters.domain>>" \
              --header "Authorization: Bearer <<parameters.api_token>>" \
              > /tmp/stoplight/response.json 2>/dev/null
            [[ $(cat /tmp/stoplight/response.json | jq '.ok') = 'true' ]]
